---
title: "CCISS Report"
output:
  prettydoc::html_pretty:
    theme: cayman
    self_contained: yes
    mode: selfcontained
params:
  userdata: NA
---

```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(bccciss)
  library(leaflet)
  library(plotly)
  library(knitr)
  library(htmltools)
})
opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE, message = FALSE, warning = FALSE)

# assign in current environment
for (nm in names(userdata)) {assign(nm, userdata[[nm]])}

# Env variable for map
bcgov_tileserver <- Sys.getenv("BCGOV_TILESERVER")
bcgov_tilelayer <- Sys.getenv("BCGOV_TILELAYER")
mbtk <- Sys.getenv("BCGOV_MAPBOX_TOKEN")
mblbstyle <- Sys.getenv("BCGOV_MAPBOX_LABELS_STYLE")
```

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri("www/logo.svg"), 
               alt = 'logo', 
               style = 'position:absolute; top:10px; left:10px;padding:10px;')
```

<span style="color:white; position: absolute; top:16px; padding:10px; left: 190px; font-size:0.5em; font-weight:800">Ministry of Forests, Lands, Natural<br />Resource Operations & Rural Development<br />Climate Change and Integrated Planning Branch</span>

<style type="text/css">
  div.datatables { height: auto !important; page-break-after: always;}
  .newpage { page-break-after: always; }
  h2 { page-break-before: always; border-top:3px solid}
</style>

  
| Parameters | User selections |
| :------------------- | :------------- |
| Representative Concentration Pathways | `r paste(rcp, collapse = " and ")` |
| Number of Points Considered | `r nrow(pts)` |
|  Averaged? | `r avg` |
|  Date | `r Sys.Date()` |
|  Time | `r format(Sys.time(), "%H:%M", usetz = TRUE)` |

```{r maps, out.width="100%", results='asis'}
data_points <- pts[!is.na(Long) & !is.na(Lat)]
leaflet::leaflet() %>%
  leaflet::addProviderTiles(leaflet::providers$CartoDB.PositronNoLabels, group = "Positron") %>%
  addVectorGridTilesDev(app = FALSE) %>% leaflet::hideGroup("Zones") %>%
  leaflet::addTiles(
    urlTemplate = paste0("https://api.mapbox.com/styles/v1/", mblbstyle, "/tiles/{z}/{x}/{y}?access_token=", mbtk),
    attribution = '&#169; <a href="https://www.mapbox.com/feedback/">Mapbox</a>',
    options = leaflet::tileOptions(zIndex = 600)) %>%
  leaflet::addMarkers(data = data_points, lng = ~Long, lat = ~Lat)
```

```{r reports, results='asis', out.height="auto"}
htmltools::tagList(
  lapply(names(siteseries_list), function(siteref) {
    siteseries <- siteseries_list[[siteref]]
    siteseries <- siteseries[siteseries %in% site_series_filter]
    htmltools::tagList(
      tags$h2(paste("Site reference:", siteref)),
      lapply(siteseries, function(siteserie) {
        htmltools::tagList(
          tags$h3(paste("Site Serie", siteserie)),
          tags$h4("Feasible Species"),
          cciss_results_dt(cciss_results, siteref, siteserie, filter = "f"),
          tags$h4("Summary of Results"),
          cciss_summary_dt(cciss_summary, siteref, siteserie),
          standardblocks(cciss_results, siteref, siteserie),
          tags$hr(class = "newpage", style = "height:0;border:0")
        )
      }),
      tags$h3(paste("Ratio of Models Predicting BGC", bgc[SiteRef %in% siteref]$BGC[1])),
      bgc_fut_plotly(bgc, siteref, period_map),
    )
  })
)
```

<!-- ## Silviculture reference -->
<!-- <small>Klinka et al. 2000. Ecological and Silvical Characteristics of Tree Species</small> -->

<!-- ### Tolerance comparisons -->
<!-- ```{r silref1 , results='asis', out.width="100%"} -->
<!-- silv_ref_dt(silvics_tol, filter = "a") -->
<!-- ``` -->

<!-- ### Resistance and potential risk comparisons -->
<!-- ```{r silref2 , results='asis', out.width="100%"} -->
<!-- silv_ref_dt(silvics_resist, filter = "a") -->
<!-- ``` -->

<!-- ### Comparison of silvical characteristics; regeneration stage -->
<!-- ```{r silref3 , results='asis', out.width="100%"} -->
<!-- silv_ref_dt(silvics_regen, filter = "a") -->
<!-- ``` -->

<!-- ### Maturing stage -->
<!-- ```{r silref4 , results='asis', out.width="100%"} -->
<!-- silv_ref_dt(silvics_mature, filter = "a") -->
<!-- ``` -->

### Annexe

```{r points, results='asis', out.width="100%"}
knitr::kable(caption = "User points of interest", pts[,list(ID, Site, Latitude = Lat, Longitude = Long, Elevation = Elev, BGC)])
```

```{r modelinfo, results='asis', out.width="100%"}
knitr::kable(models_info, caption = "Model information")
```
